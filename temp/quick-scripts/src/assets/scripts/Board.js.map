{"version":3,"sources":["assets/scripts/Board.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import config from './constants/config'\nimport { getNewPositionByStep } from './utils/getNewPositionByStep';\nconst { ccclass, property } = cc._decorator;\n\n@ccclass\nexport default class Board extends cc.Component {\n\n    bubblePrefab: cc.Prefab\n\n    board: Array<Array<cc.Node | null>> = new Array(config.BOARD_WIDTH).fill(null).map(() => new Array(config.BOARD_HEIGHT).fill(null));\n\n    stepX: number\n\n    stepY: number\n\n    onBubbleClick: (position: cc.Vec2) => void = () => { };\n\n    initGame(bubblePrefab: cc.Prefab, onBubbleClick: VoidFunction) {\n        console.log('INIT', bubblePrefab);\n        this.initStep()\n        this.bubblePrefab = bubblePrefab\n        this.onBubbleClick = onBubbleClick\n        this.createBoard()\n    }\n\n    clear() {\n        for (let y = 0; y < config.BOARD_WIDTH; y++) {\n            for (let x = 0; x < config.BOARD_HEIGHT; x++) {\n                const node = this.board[y]?.[x];\n                if (node && node.isValid) {\n                    node.destroy();\n                }\n            }\n        }\n        this.board = new Array(config.BOARD_WIDTH).fill(null).map(() => new Array(config.BOARD_HEIGHT).fill(null));\n    }\n\n    createBoard() {\n        const sizeY = config.BOARD_HEIGHT;\n        const sizeX = config.BOARD_WIDTH;\n\n\n        for (let x = 0; x < sizeX; x++) {\n            for (let y = 0; y < sizeY; y++) {\n                const node = this.createBubble(cc.v2(x, y));\n                this.board[x][y] = node\n            }\n        }\n        console.log('board', this.board);\n\n    }\n\n    createBubble(position: cc.Vec2): cc.Node {\n        const newBubble = cc.instantiate(this.bubblePrefab)\n        const bubble = newBubble.getComponent('Bubble')\n        const newPositionByStep = getNewPositionByStep(position, this.stepX, this.stepY)\n        bubble.initType()\n        bubble.initCoord(position)\n        bubble.initSize(this.stepX > this.stepY ? this.stepY * 0.8 : this.stepX * 0.8)\n        bubble.setBubblePosition(newPositionByStep)\n        newBubble.on('bubble-click', this.handleBubbleClick, this);\n        this.node.addChild(newBubble)\n        return newBubble\n    }\n\n    getGroupToRemove(startPosition: cc.Vec2) {\n        const startBubbleNode = this.board[startPosition.x][startPosition.y]\n        if (!startBubbleNode) return\n        const startBubble = startBubbleNode.getComponent('Bubble')\n\n        const visited = new Set<string>();\n\n        const groupToRemove: cc.Node[] = []\n\n        const searchNeighbor = (pos: cc.Vec2) => {\n            console.log('pos');\n            if (pos.x < 0 || pos.y < 0 || pos.x >= config.BOARD_WIDTH || pos.y >= config.BOARD_HEIGHT) return;\n            const key = `${pos.x},${pos.y}`;\n            if (visited.has(key)) return;\n\n            const node = this.board[pos.x][pos.y];\n            if (!node) return;\n\n            const bubble = node.getComponent('Bubble');\n            if (bubble.type === startBubble.type) {\n                visited.add(key);\n                groupToRemove.push(node);\n                searchNeighbor(cc.v2(pos.x + 1, pos.y));\n                searchNeighbor(cc.v2(pos.x - 1, pos.y));\n                searchNeighbor(cc.v2(pos.x, pos.y + 1));\n                searchNeighbor(cc.v2(pos.x, pos.y - 1));\n            }\n\n\n        };\n        searchNeighbor(startPosition)\n        return groupToRemove\n    }\n\n\n    removeGroup(group: cc.Node[]): number {\n        if (group.length < 2) return 0\n        for (let i = 0; i < group.length; i++) {\n            const bubble = group[i].getComponent('Bubble')\n            this.board[bubble.coord.x][bubble.coord.y] = null\n            bubble.bubbleDestroy(i)\n        }\n        this.fillEmptySpace(group.length)\n        return group.length\n    }\n\n    fillEmptySpace(emtyCount: number) {\n        for (let x = 0; x < config.BOARD_WIDTH; x++) {\n            let stepToDown = 0\n            for (let y = 0; y < config.BOARD_HEIGHT; y++) {\n                const node = this.board[x][y]\n                if (!node) {\n                    stepToDown++\n                }\n                else if (node && stepToDown > 0) {\n                    const bubble = node.getComponent('Bubble')\n                    const newPosition = getNewPositionByStep(cc.v2(x, y - stepToDown), this.stepX, this.stepY)\n                    bubble.moveToPosition(newPosition, emtyCount)\n                    bubble.initCoord(cc.v2(x, y - stepToDown))\n                    this.board[x][y - stepToDown] = node\n                    this.board[x][y] = null\n                }\n                else continue\n            }\n            for (let i = 0; i < stepToDown; i++) {\n                const newBubble = this.createBubble(cc.v2(x, config.BOARD_HEIGHT))\n                const bubble = newBubble.getComponent('Bubble')\n                bubble.initCoord(cc.v2(x, config.BOARD_HEIGHT - stepToDown + i))\n                this.board[x][config.BOARD_HEIGHT - stepToDown + i] = newBubble\n                const newPosition = getNewPositionByStep(cc.v2(x, config.BOARD_HEIGHT - stepToDown + i), this.stepX, this.stepY)\n                bubble.moveToPosition(newPosition, emtyCount + i*2)\n            }\n        }\n\n    }\n\n\n\n    handleBubbleClick(position: cc.Vec2) {\n        this.onBubbleClick(position);\n    }\n\n    initStep() {\n        this.stepX = (this.node.width - config.BOARD_SIZE * 2) / config.BOARD_WIDTH\n        this.stepY = (this.node.height - config.BOARD_SIZE * 2) / config.BOARD_HEIGHT\n    }\n\n\n}\n"]}